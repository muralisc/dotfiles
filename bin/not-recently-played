#!/bin/bash

# Usage:
# $0 copy - do copy
# $0      - print the dry run 
if [[ -z "$1" ]]; then
echo "Usage:"
echo "	bash ~/bin/not-recently-played dry ~/data/Media/videos/forsorting/ ~/shared_folders/transfer_private/vids"
echo "	bash ~/bin/not-recently-played dry ~//data/Songs/Malayalam ~/shared_folders/transfer_private/songs/cron_songs/"
fi

alias np="bash ~/src/dotfiles/bin/not-recently-played cp ~/data/Media/notForKids/videos/forsorting/ ~/shared_folders/transfer_private/x_copy"
alias nm="bash ~/src/dotfiles/bin/not-recently-played cp ~/data/Songs/Malayalam  ~/shared_folders/transfer_london_home/songs/cron_songs"
alias nf="bash ~/src/dotfiles/bin/not-recently-played cp ~/data/footage/2021/ ~/shared_folders/transfer_london_home/footage_copy/photos 2022-05-01 10"
alias nf="bash ~/src/dotfiles/bin/not-recently-played cp ~/data/footage/2021/ ~/shared_folders/transfer_london_home/footage_copy/videos 2022-05-01 10"

# $1 - do copy or dry run
copy_command=${1:-echo}
SONGS_FOLDER="${2:-$HOME/data/Songs/Malayalam}" # TODO comma separated source folders
DEST_FOLDER="${3:-$HOME/shared_folders/transfer_private/songs/cron_songs/}"
THIRTY_DAYS_BEFORE_DATE="${4:-2022-03-28}"
NO_OF_FILES_TO_COPY="${5:-5}"
# FIND_EXCLUDE='-not -ipath "*1960*" -ipath "*JPG"'
FIND_EXCLUDE='-not -ipath "*CR3" -not -ipath "*pp3" -not -ipath "*lrv" -not -ipath "*thm"'
touch ${DEST_FOLDER}/skip_files.txt
EXCLUDE_FILE_LIST_CMD="grep -vFf ${DEST_FOLDER}/skip_files.txt"

NUMBER_OF_ITEMS_LEFT=$(eval "find $SONGS_FOLDER -type f -not -newerat ${THIRTY_DAYS_BEFORE_DATE} ${FIND_EXCLUDE} | $EXCLUDE_FILE_LIST_CMD " | wc -l)

echo "$(date -Is) Running Cleanup script, remaining items: $NUMBER_OF_ITEMS_LEFT"
mkdir -p $DEST_FOLDER
python ~/src/dotfiles/bin/not-recently-played-cleanup $DEST_FOLDER
eval "find $SONGS_FOLDER -type f -not -newerat ${THIRTY_DAYS_BEFORE_DATE} $FIND_EXCLUDE  | $EXCLUDE_FILE_LIST_CMD " |\
	shuf |\
	head -${NO_OF_FILES_TO_COPY} |\
	xargs -I'{}' $copy_command -v '{}' $DEST_FOLDER | tee $DEST_FOLDER/copy_paths.log

find $DEST_FOLDER \
	-type f \
	-printf "%AY-%Am-%Ad %AH:%AM:%AS %p\n" > $DEST_FOLDER/access_times.log

