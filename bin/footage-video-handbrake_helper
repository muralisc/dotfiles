#!/bin/bash

SOURCE_ROOT="$1"
DESTINATION_ROOT="$2"
PATH_REGEX="$3"
DRY_RUN="$4"

echo find $SOURCE_ROOT -regex "$PATH_REGEX"
mkdir -p $DESTINATION_ROOT

preset="Very Fast 1080p30"
preset="HQ 2160p60 4K HEVC Surround"
preset="Fast 1080p30"

for file_path in $(find $SOURCE_ROOT -type f -regex "$PATH_REGEX"); do
    echo "----------------------"
    echo "Converting: $file_path"
    FILE_DIRECTORY=$(dirname $file_path)
    filename=$(basename $file_path)
    filename_without_ext="${filename%.*}"
    extension="${filename##*.}"
    RELATIVE_PATH_TO_SOURCE_ROOT=${FILE_DIRECTORY#"$SOURCE_ROOT"}
    DEST_FILE_DIRECTORY="${DESTINATION_ROOT}$RELATIVE_PATH_TO_SOURCE_ROOT"
    mkdir -p $DEST_FILE_DIRECTORY
    DEST_FILE_PATH="${DEST_FILE_DIRECTORY}/${filename_without_ext}-${preset}"
    if [[ -f $DEST_FILE_PATH ]] ; then
        continue
    fi
    echo "-> To desitnation: $DEST_FILE_PATH"
    HandBrakeCLI -Z "$preset" -i "$filepath" -o "$DEST_FILE_PATH"
done
