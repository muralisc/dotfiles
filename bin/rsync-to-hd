#!/bin/bash

# This script syncs home folder to a harddisk or a network path

GIVEN_PATH="$1"
if [[ -z $GIVEN_PATH ]]; then
  EXCLUDE_FILE=${1:-/tmp/exclude_file.txt}
  EXTERNALHD_UUID=57dddd4c-88ba-40d5-88ce-ff093119b2be
  EXTERNALHD_MNT=$(findmnt -S UUID=$EXTERNALHD_UUID -rn -o TARGET)
fi
if [[ -z $EXTERNALHD_MNT ]] && [[ -z $GIVEN_PATH ]]; then
  echo "Mount point is not found, Eitehr a mount point or a path needs to be given"
  exit
fi
SOURCE_PATH=${HOME}/
if [[ -z "$GIVEN_PATH" ]] ; then
  echo -e "Found mount point for UUID = $EXTERNALHD_UUID at $(tput bold)$EXTERNALHD_MNT$(tput sgr0)"
  BACKUP_PATH=${EXTERNALHD_MNT}/mylap/
else
  BACKUP_PATH=${GIVEN_PATH}/mylap/
fi
echo "Contents of Exclude file:"
echo "-------------------------"
cat "$EXCLUDE_FILE"
echo "$(tput setaf 4)Proceed with the dry run?$(tput sgr0)"
read -r
mkdir -p "$BACKUP_PATH"
BLUE=$(tput setaf 4)
echo -e "Doing a dry run from ${BLUE}${SOURCE_PATH}$(tput sgr0) to ${BLUE}${BACKUP_PATH}$(tput sgr0)"


# create exclude file if it does not exist
[ -f "$EXCLUDE_FILE" ] || touch "$EXCLUDE_FILE"
# always exclude hidden folders/files
# Add .* only if not found in file already
grep '.*' "$EXCLUDE_FILE" || echo '.*' >> "$EXCLUDE_FILE"
# Explanation of below command
# SYNC_COMMAND="
# rsync
#   --archive                               # self explanatory
#   --human-readable                        # show in GB and MB
#   --itemize-changes                       # show current file being txfered
#   --partial
#   --delete
#   --stats
#   --info=progress2                        # VVI show overall % , does not work with -v
#   --exclude-from=$EXCLUDE_FILE            # Specified .* to exclude dotfiles
#   --cvs-exclude
#   $SOURCE_PATH ${BACKUP_PATH}
# "
SYNC_COMMAND="
rsync
  --archive
  --human-readable
  --itemize-changes
  --partial
  --delete
  --stats
  --info=progress2
  --exclude-from=$EXCLUDE_FILE
  --cvs-exclude
  $SOURCE_PATH ${BACKUP_PATH}
"
$SYNC_COMMAND -n | tee /var/log/rsync_dry.log

echo "$(tput setaf 4)Proceed with the sync?$(tput sgr0)"
read -r

$SYNC_COMMAND | tee /var/log/rsync.log
